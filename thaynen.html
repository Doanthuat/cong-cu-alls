<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="C√¥ng c·ª• thay ƒë·ªïi n·ªÅn ·∫£nh h√†ng lo·∫°t online mi·ªÖn ph√≠. H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh: PNG, JPG, GIF, BMP, WEBP, SVG, TIFF, AVIF, HEIC v√† nhi·ªÅu h∆°n n·ªØa.">
    <meta name="keywords" content="thay ƒë·ªïi n·ªÅn ·∫£nh, x√≥a n·ªÅn ·∫£nh, PNG trong su·ªët, c√¥ng c·ª• ch·ªânh s·ª≠a ·∫£nh online, t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="C√¥ng c·ª• thay ƒë·ªïi n·ªÅn ·∫£nh h√†ng lo·∫°t - H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng">
    <meta property="og:description" content="Thay ƒë·ªïi n·ªÅn ·∫£nh v·ªõi h·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh. C√¥ng c·ª• online mi·ªÖn ph√≠, d·ªÖ s·ª≠ d·ª•ng v·ªõi th·ªëng k√™ chi ti·∫øt.">
    <meta property="og:type" content="website">
    <title>C√¥ng c·ª• thay ƒë·ªïi n·ªÅn ·∫£nh h√†ng lo·∫°t - H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng | DVNT</title>
    <link rel="canonical" href="https://example.com/cong-cu-thay-doi-nen-anh">
    <link rel="stylesheet" href="./asset/css/style.css">
    <!-- JSZip Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" 
            integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
</head>
<header class="doitenhinhanhsticky__header" id="doitenhinhanhsticky__header">
        <!-- render header -->
    </header>
    <!-- ƒêo·∫°n scrip render header -->
    <script>
        fetch('./templates/header.html')
            .then(response => response.text())
            .then(data => {
                document.querySelector("#doitenhinhanhsticky__header").innerHTML = data;
            })
            .catch(error => console.error('L·ªói:', error));
    </script>
<body class="dvnt-thaydoinen">
    <!-- Header -->
    <header class="dvnt-thaydoinen__header">
        <div class="dvnt-thaydoinen__container">
            <h1 class="dvnt-thaydoinen__title">C√¥ng c·ª• thay ƒë·ªïi n·ªÅn ·∫£nh h√†ng lo·∫°t</h1>
            <p class="dvnt-thaydoinen__subtitle">H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh v·ªõi th·ªëng k√™ chi ti·∫øt - PNG, JPG, GIF, WEBP, SVG, TIFF, AVIF, HEIC v√† nhi·ªÅu h∆°n n·ªØa</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="dvnt-thaydoinen__main">
        <div class="dvnt-thaydoinen__container">
            <!-- Upload Section -->
            <section class="dvnt-thaydoinen__upload-section">
                <h2 class="dvnt-thaydoinen__section-title">1. T·∫£i ·∫£nh l√™n</h2>
                <div class="dvnt-thaydoinen__upload-area">
                    <div class="dvnt-thaydoinen__upload-zone">
                        <div class="dvnt-thaydoinen__upload-icon">üìÅ</div>
                        <p class="dvnt-thaydoinen__upload-text">K√©o th·∫£ ·∫£nh v√†o ƒë√¢y ho·∫∑c</p>
                        <button class="dvnt-thaydoinen__upload-btn">Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh</button>
                        <input type="file" 
                               class="dvnt-thaydoinen__upload-input" 
                               accept="image/*"
                               multiple>
                        <p class="dvnt-thaydoinen__upload-note">
                            H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh: PNG, JPG, JPEG, GIF, BMP, WEBP, SVG, TIFF, AVIF, HEIC, ICO, RAW v√† nhi·ªÅu h∆°n n·ªØa (t·ªëi ƒëa 50MB m·ªói ·∫£nh)
                        </p>
                    </div>
                </div>
                <!-- Statistics Section -->
                <div class="dvnt-thaydoinen__stats-section" style="display: none;">
                    <h3 class="dvnt-thaydoinen__stats-title">üìä Th·ªëng k√™ chi ti·∫øt</h3>
                    <div class="dvnt-thaydoinen__stats-grid">
                        <div class="dvnt-thaydoinen__stat-item">
                            <span class="dvnt-thaydoinen__stat-label">T·ªïng s·ªë ·∫£nh:</span>
                            <span class="dvnt-thaydoinen__stat-value" id="total-images">0</span>
                        </div>
                        <div class="dvnt-thaydoinen__stat-item">
                            <span class="dvnt-thaydoinen__stat-label">K√≠ch th∆∞·ªõc g·ªëc:</span>
                            <span class="dvnt-thaydoinen__stat-value" id="original-size">0 MB</span>
                        </div>
                        <div class="dvnt-thaydoinen__stat-item">
                            <span class="dvnt-thaydoinen__stat-label">K√≠ch th∆∞·ªõc m·ªõi:</span>
                            <span class="dvnt-thaydoinen__stat-value" id="new-size">0 MB</span>
                        </div>
                        <div class="dvnt-thaydoinen__stat-item">
                            <span class="dvnt-thaydoinen__stat-label">T·ª∑ l·ªá n√©n:</span>
                            <span class="dvnt-thaydoinen__stat-value" id="compression-ratio">0%</span>
                        </div>
                        <div class="dvnt-thaydoinen__stat-item">
                            <span class="dvnt-thaydoinen__stat-label">Dung l∆∞·ª£ng ti·∫øt ki·ªám:</span>
                            <span class="dvnt-thaydoinen__stat-value" id="saved-size">0 MB</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Background Selection -->
            <section class="dvnt-thaydoinen__background-section">
                <h2 class="dvnt-thaydoinen__section-title">2. Ch·ªçn n·ªÅn m·ªõi</h2>
                <div class="dvnt-thaydoinen__background-tabs">
                    <button class="dvnt-thaydoinen__tab dvnt-thaydoinen__tab--active" data-tab="color">M√†u s·∫Øc</button>
                    <button class="dvnt-thaydoinen__tab" data-tab="landscape">Phong c·∫£nh</button>
                    <button class="dvnt-thaydoinen__tab" data-tab="pattern">H·ªça ti·∫øt</button>
                    <button class="dvnt-thaydoinen__tab" data-tab="upload">T·∫£i l√™n</button>
                </div>
                
                <div class="dvnt-thaydoinen__background-grid">
                    <!-- Background items s·∫Ω ƒë∆∞·ª£c t·∫°o b·ªüi JavaScript -->
                </div>
            </section>

            <!-- Preview Section -->
            <section class="dvnt-thaydoinen__preview-section">
                <h2 class="dvnt-thaydoinen__section-title">3. Xem tr∆∞·ªõc v√† ƒëi·ªÅu ch·ªânh</h2>
                <div class="dvnt-thaydoinen__preview-area">
                    <div class="dvnt-thaydoinen__preview-container">
                        <div class="dvnt-thaydoinen__preview-placeholder">
                            <p class="dvnt-thaydoinen__preview-text">·∫¢nh xem tr∆∞·ªõc s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y</p>
                        </div>
                    </div>
                    <div class="dvnt-thaydoinen__controls">
                        <div class="dvnt-thaydoinen__control-group">
                            <label class="dvnt-thaydoinen__control-label">K√≠ch th∆∞·ªõc:</label>
                            <input type="range" class="dvnt-thaydoinen__control-slider" min="10" max="300" value="100">
                            <span class="dvnt-thaydoinen__control-value">100%</span>
                        </div>
                        <div class="dvnt-thaydoinen__control-group">
                            <label class="dvnt-thaydoinen__control-label">V·ªã tr√≠ X:</label>
                            <input type="range" class="dvnt-thaydoinen__control-slider" min="-200" max="200" value="0">
                            <span class="dvnt-thaydoinen__control-value">0px</span>
                        </div>
                        <div class="dvnt-thaydoinen__control-group">
                            <label class="dvnt-thaydoinen__control-label">V·ªã tr√≠ Y:</label>
                            <input type="range" class="dvnt-thaydoinen__control-slider" min="-200" max="200" value="0">
                            <span class="dvnt-thaydoinen__control-value">0px</span>
                        </div>
                        <div class="dvnt-thaydoinen__control-group">
                            <label class="dvnt-thaydoinen__control-label">ƒê·ªô m·ªù:</label>
                            <input type="range" class="dvnt-thaydoinen__control-slider" min="0" max="100" value="100">
                            <span class="dvnt-thaydoinen__control-value">100%</span>
                        </div>
                        <div class="dvnt-thaydoinen__control-group">
                            <button class="dvnt-thaydoinen__reset-btn">Reset t·∫•t c·∫£</button>
                        </div>
                        <div class="dvnt-thaydoinen__control-group">
                            <button class="dvnt-thaydoinen__prev-btn">‚Üê ·∫¢nh tr∆∞·ªõc</button>
                            <button class="dvnt-thaydoinen__next-btn">·∫¢nh sau ‚Üí</button>
                        </div>
                        <!-- Th√™m v√†o ph·∫ßn .dvnt-thaydoinen__controls trong HTML -->
                        <div class="dvnt-thaydoinen__control-group">
                            <div class="dvnt-thaydoinen__history-controls">
                                <button class="dvnt-thaydoinen__undo-btn dvnt-thaydoinen__btn--disabled" disabled>‚Ü∂ Ho√†n t√°c</button>
                                <button class="dvnt-thaydoinen__redo-btn dvnt-thaydoinen__btn--disabled" disabled>‚Ü∑ L√†m l·∫°i</button>
                            </div>
                        </div>

                        <div class="dvnt-thaydoinen__control-group">
                            <button class="dvnt-thaydoinen__comparison-btn">üîç So s√°nh Before/After</button>
                        </div>

                        <!-- Th√™m keyboard shortcuts info -->
                        <div class="dvnt-thaydoinen__shortcuts-info">
                            <details>
                                <summary>‚å®Ô∏è Ph√≠m t·∫Øt</summary>
                                <ul>
                                    <li><kbd>Ctrl+Z</kbd> - Ho√†n t√°c</li>
                                    <li><kbd>Ctrl+Y</kbd> - L√†m l·∫°i</li>
                                    <li><kbd>Space</kbd> - ·∫¢nh ti·∫øp theo</li>
                                    <li><kbd>‚Üê</kbd><kbd>‚Üí</kbd> - ƒêi·ªÅu h∆∞·ªõng ·∫£nh</li>
                                    <li><kbd>R</kbd> - Reset ƒëi·ªÅu khi·ªÉn</li>
                                    <li><kbd>C</kbd> - So s√°nh Before/After</li>
                                    <li><kbd>Ctrl+Enter</kbd> - T·∫£i v·ªÅ ·∫£nh</li>
                                </ul>
                            </details>
                        </div>

                    </div>
                </div>
            </section>

            <!-- Download Section -->
            <section class="dvnt-thaydoinen__download-section">
                <h2 class="dvnt-thaydoinen__section-title">4. T·∫£i v·ªÅ ·∫£nh ho√†n ch·ªânh</h2>
                <div class="dvnt-thaydoinen__download-options">
                    <div class="dvnt-thaydoinen__format-selection">
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="png" class="dvnt-thaydoinen__format-input" checked>
                            <span class="dvnt-thaydoinen__format-label">PNG (n·ªÅn trong su·ªët)</span>
                        </label>
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="jpg" class="dvnt-thaydoinen__format-input">
                            <span class="dvnt-thaydoinen__format-label">JPG (n·ªÅn ƒë√£ thay)</span>
                        </label>
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="webp" class="dvnt-thaydoinen__format-input">
                            <span class="dvnt-thaydoinen__format-label">WEBP (k√≠ch th∆∞·ªõc nh·ªè)</span>
                        </label>
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="gif" class="dvnt-thaydoinen__format-input">
                            <span class="dvnt-thaydoinen__format-label">GIF (animation)</span>
                        </label>
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="bmp" class="dvnt-thaydoinen__format-input">
                            <span class="dvnt-thaydoinen__format-label">BMP (ch·∫•t l∆∞·ª£ng cao)</span>
                        </label>
                        <label class="dvnt-thaydoinen__format-option">
                            <input type="radio" name="format" value="tiff" class="dvnt-thaydoinen__format-input">
                            <span class="dvnt-thaydoinen__format-label">TIFF (chuy√™n nghi·ªáp)</span>
                        </label>
                    </div>
                    
                    <div class="dvnt-thaydoinen__quality-selection">
                        <label class="dvnt-thaydoinen__quality-label">Ch·∫•t l∆∞·ª£ng xu·∫•t:</label>
                        <input type="range" class="dvnt-thaydoinen__quality-slider" min="10" max="100" value="90">
                        <span class="dvnt-thaydoinen__quality-value">90%</span>
                    </div>
                    
                    <div class="dvnt-thaydoinen__download-actions">
                        <button class="dvnt-thaydoinen__download-btn dvnt-thaydoinen__download-btn--disabled" disabled>
                            T·∫£i v·ªÅ ·∫£nh hi·ªán t·∫°i
                        </button>
                        <button class="dvnt-thaydoinen__download-btn  dvnt-thaydoinen__download-btn--disabled" disabled>
                            T·∫£i v·ªÅ t·∫•t c·∫£ (ZIP)
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer class="dvnt-footer" id="dvnt-footer"></footer>
        <script>
        fetch('./templates/footer.html')
            .then(response => response.text())
            .then(data => {
                document.querySelector("#dvnt-footer").innerHTML = data;
            })
            .catch(error => console.error('L·ªói:', error));
    </script>

    <script>
        class DVNTBackgroundChanger {
    constructor() {
        // Ki·ªÉm tra JSZip c√≥ s·∫µn kh√¥ng
        if (typeof JSZip === 'undefined') {
            console.error('JSZip library is not loaded!');
            alert('L·ªói: Th∆∞ vi·ªán JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng t·∫£i l·∫°i trang.');
            return;
        }

        // H·ªó tr·ª£ t·∫•t c·∫£ ƒë·ªãnh d·∫°ng ·∫£nh
        this.supportedImageTypes = [
            'image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp',
            'image/webp', 'image/svg+xml', 'image/tiff', 'image/tif', 'image/avif',
            'image/apng', 'image/ico', 'image/heic', 'image/heif', 'image/x-icon',
            'image/raw', 'image/cr2', 'image/nef', 'image/arw', 'image/dng'
        ];
        
        this.supportedExtensions = [
            '.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.tiff', 
            '.tif', '.avif', '.apng', '.ico', '.heic', '.heif', '.raw', '.cr2', 
            '.nef', '.arw', '.dng', '.psd', '.ai', '.eps'
        ];
        
        // Core properties
        this.canvas = null;
        this.ctx = null;
        this.selectedFiles = [];
        this.selectedBackground = '#ffffff';
        this.backgroundType = 'color'; // FIX: Set default type
        this.currentImageIndex = 0;
        this.currentImage = null;
        this.selectedFormat = 'png';
        this.quality = 0.9;
        this.originalTotalSize = 0;
        this.newTotalSize = 0;
        this.processedImages = [];
        
        // History system
        this.history = [];
        this.historyIndex = -1;
        this.maxHistorySize = 20;
        
        // Performance monitoring
        this.performanceMetrics = {
            processingTimes: [],
            memoryUsage: [],
            startTime: performance.now()
        };
        
        // Auto-save
        this.autoSaveInterval = null;
        
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.initializeCanvas();
        this.updateBackgroundGrid();
        this.initializeAdvancedFeatures();
    }

    // ==================== EVENT LISTENERS - FIXED ====================
    setupEventListeners() {
        // Upload events
        const uploadInput = document.querySelector('.dvnt-thaydoinen__upload-input');
        const uploadBtn = document.querySelector('.dvnt-thaydoinen__upload-btn');
        const uploadZone = document.querySelector('.dvnt-thaydoinen__upload-zone');

        if (uploadBtn && uploadInput) {
            uploadBtn.addEventListener('click', () => uploadInput.click());
            uploadInput.addEventListener('change', (e) => this.handleFileSelect(e));
        }

        // Drag and drop events
        if (uploadZone) {
            uploadZone.addEventListener('dragover', (e) => this.handleDragOver(e));
            uploadZone.addEventListener('drop', (e) => this.handleDrop(e));
            uploadZone.addEventListener('dragenter', (e) => this.handleDragEnter(e));
            uploadZone.addEventListener('dragleave', (e) => this.handleDragLeave(e));
        }

        // FIX: Background tabs - Use event delegation
        const backgroundTabsContainer = document.querySelector('.dvnt-thaydoinen__background-tabs');
        if (backgroundTabsContainer) {
            backgroundTabsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('dvnt-thaydoinen__tab')) {
                    this.handleTabChange(e);
                }
            });
        }

        // FIX: Background grid - Use event delegation for dynamic items
        const backgroundGrid = document.querySelector('.dvnt-thaydoinen__background-grid');
        if (backgroundGrid) {
            backgroundGrid.addEventListener('click', (e) => {
                if (e.target.classList.contains('dvnt-thaydoinen__background-item') || 
                    e.target.closest('.dvnt-thaydoinen__background-item')) {
                    const item = e.target.classList.contains('dvnt-thaydoinen__background-item') ? 
                                e.target : e.target.closest('.dvnt-thaydoinen__background-item');
                    this.handleBackgroundSelect({ currentTarget: item });
                }
            });
        }

        // Control sliders
        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        sliders.forEach((slider, index) => {
            slider.addEventListener('input', (e) => this.handleControlChange(e, index));
        });

        // Quality slider
        const qualitySlider = document.querySelector('.dvnt-thaydoinen__quality-slider');
        if (qualitySlider) {
            qualitySlider.addEventListener('input', (e) => this.handleQualityChange(e));
        }

        // Navigation buttons
        const prevBtn = document.querySelector('.dvnt-thaydoinen__prev-btn');
        const nextBtn = document.querySelector('.dvnt-thaydoinen__next-btn');
        const resetBtn = document.querySelector('.dvnt-thaydoinen__reset-btn');

        if (prevBtn) prevBtn.addEventListener('click', () => this.previousImage());
        if (nextBtn) nextBtn.addEventListener('click', () => this.nextImage());
        if (resetBtn) resetBtn.addEventListener('click', () => this.resetControls());

        // Undo/Redo buttons
        const undoBtn = document.querySelector('.dvnt-thaydoinen__undo-btn');
        const redoBtn = document.querySelector('.dvnt-thaydoinen__redo-btn');
        
        if (undoBtn) undoBtn.addEventListener('click', () => this.undo());
        if (redoBtn) redoBtn.addEventListener('click', () => this.redo());

        // Comparison button
        const comparisonBtn = document.querySelector('.dvnt-thaydoinen__comparison-btn');
        if (comparisonBtn) {
            comparisonBtn.addEventListener('click', () => this.createComparisonView());
        }

        // Download buttons
        const downloadBtn = document.querySelector('.dvnt-thaydoinen__download-btn');
        const downloadAllBtn = document.querySelector('.dvnt-thaydoinen__download-all-btn');
        
        if (downloadBtn) downloadBtn.addEventListener('click', () => this.downloadImage());
        if (downloadAllBtn) downloadAllBtn.addEventListener('click', () => this.downloadAllImages());

        // Format selection
        const formatInputs = document.querySelectorAll('.dvnt-thaydoinen__format-input');
        formatInputs.forEach(input => {
            input.addEventListener('change', (e) => this.handleFormatChange(e));
        });
    }

    // ==================== CANVAS INITIALIZATION ====================
    initializeCanvas() {
        const previewContainer = document.querySelector('.dvnt-thaydoinen__preview-container');
        if (!previewContainer) return;

        this.canvas = document.createElement('canvas');
        this.canvas.width = 800;
        this.canvas.height = 600;
        this.canvas.style.maxWidth = '100%';
        this.canvas.style.height = 'auto';
        this.canvas.style.borderRadius = '10px';
        this.ctx = this.canvas.getContext('2d');
        
        previewContainer.innerHTML = '';
        previewContainer.appendChild(this.canvas);
        
        this.drawBackground();
    }

    // ==================== FILE VALIDATION & HANDLING ====================
    isValidImageFile(file) {
        const isValidMimeType = this.supportedImageTypes.includes(file.type.toLowerCase());
        const fileName = file.name.toLowerCase();
        const isValidExtension = this.supportedExtensions.some(ext => fileName.endsWith(ext));
        
        const specialFormats = ['.psd', '.ai', '.eps', '.raw', '.cr2', '.nef', '.arw', '.dng'];
        const isSpecialFormat = specialFormats.some(ext => fileName.endsWith(ext));
        
        return isValidMimeType || isValidExtension || isSpecialFormat;
    }

    handleFileSelect(event) {
        const files = Array.from(event.target.files);
        this.processFiles(files);
    }

    handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dvnt-thaydoinen__upload-zone--dragover');
    }

    handleDragEnter(event) {
        event.preventDefault();
    }

    handleDragLeave(event) {
        event.currentTarget.classList.remove('dvnt-thaydoinen__upload-zone--dragover');
    }

    handleDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dvnt-thaydoinen__upload-zone--dragover');
        
        const files = Array.from(event.dataTransfer.files);
        this.processFiles(files);
    }

    processFiles(files) {
        const startTime = performance.now();
        
        const imageFiles = files.filter(file => {
            if (!this.isValidImageFile(file)) {
                console.warn(`File kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£: ${file.name} (${file.type})`);
                return false;
            }
            
            if (file.size > 50 * 1024 * 1024) {
                console.warn(`File qu√° l·ªõn: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);
                return false;
            }
            
            return true;
        });
        
        if (imageFiles.length === 0) {
            this.showNotification('Kh√¥ng c√≥ file ·∫£nh h·ª£p l·ªá n√†o ƒë∆∞·ª£c ch·ªçn!', 'error');
            return;
        }

        this.originalTotalSize = imageFiles.reduce((total, file) => total + file.size, 0);

        if (imageFiles.length < files.length) {
            const skippedCount = files.length - imageFiles.length;
            this.showNotification(
                `ƒê√£ b·ªè qua ${skippedCount} file kh√¥ng h·ªó tr·ª£. T·∫£i th√†nh c√¥ng ${imageFiles.length} ·∫£nh!`, 
                'warning'
            );
        } else {
            this.showNotification(`ƒê√£ t·∫£i ${imageFiles.length} ·∫£nh th√†nh c√¥ng!`, 'success');
        }

        this.selectedFiles = imageFiles;
        this.currentImageIndex = 0;
        this.processedImages = new Array(imageFiles.length);
        this.loadCurrentImage();
        this.enableDownloadButtons();
        this.displayFileInfo();
        this.updateStatistics();
        this.showStatistics();
        
        this.logProcessingTime('File processing', startTime);
    }

    loadCurrentImage() {
        if (this.selectedFiles.length === 0) return;

        const file = this.selectedFiles[this.currentImageIndex];
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const img = new Image();
            
            img.onload = () => {
                this.currentImage = img;
                this.renderPreview();
                this.displayFileInfo();
                this.saveState();
            };
            
            img.onerror = () => {
                console.error(`Kh√¥ng th·ªÉ t·∫£i ·∫£nh: ${file.name}`);
                this.showNotification(`L·ªói t·∫£i ·∫£nh: ${file.name}`, 'error');
                
                if (this.currentImageIndex < this.selectedFiles.length - 1) {
                    this.currentImageIndex++;
                    this.loadCurrentImage();
                }
            };
            
            img.src = e.target.result;
        };
        
        reader.onerror = () => {
            console.error(`Kh√¥ng th·ªÉ ƒë·ªçc file: ${file.name}`);
            this.showNotification(`L·ªói ƒë·ªçc file: ${file.name}`, 'error');
        };
        
        reader.readAsDataURL(file);
    }

    // ==================== BACKGROUND HANDLING - FIXED ====================
    handleTabChange(event) {
        console.log('Tab change triggered:', event.target.textContent); // Debug log
        
        const tabs = document.querySelectorAll('.dvnt-thaydoinen__tab');
        tabs.forEach(tab => tab.classList.remove('dvnt-thaydoinen__tab--active'));
        event.target.classList.add('dvnt-thaydoinen__tab--active');
        
        // FIX: Get background type from text content and normalize it
        const tabText = event.target.textContent.trim().toLowerCase();
        switch(tabText) {
            case 'm√†u s·∫Øc':
                this.backgroundType = 'color';
                break;
            case 'phong c·∫£nh':
                this.backgroundType = 'landscape';
                break;
            case 'h·ªça ti·∫øt':
                this.backgroundType = 'pattern';
                break;
            case 't·∫£i l√™n':
                this.backgroundType = 'upload';
                break;
            default:
                this.backgroundType = 'color';
        }
        
        console.log('Background type set to:', this.backgroundType); // Debug log
        this.updateBackgroundGrid();
        this.saveState();
    }

    updateBackgroundGrid() {
        const grid = document.querySelector('.dvnt-thaydoinen__background-grid');
        if (!grid) return;
        
        console.log('Updating background grid for type:', this.backgroundType); // Debug log
        grid.innerHTML = '';

        switch(this.backgroundType) {
            case 'color':
                this.createColorBackgrounds(grid);
                break;
            case 'landscape':
                this.createLandscapeBackgrounds(grid);
                break;
            case 'pattern':
                this.createPatternBackgrounds(grid);
                break;
            case 'upload':
                this.createUploadBackground(grid);
                break;
            default:
                this.createColorBackgrounds(grid);
        }
    }

    createColorBackgrounds(grid) {
        const colors = [
            '#ffffff', '#000000', '#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24',
            '#6c5ce7', '#a29bfe', '#fd79a8', '#00b894', '#e17055', '#74b9ff',
            '#fab1a0', '#00cec9', '#6c5ce7', '#a29bfe', '#fd79a8', '#fdcb6e'
        ];

        colors.forEach(color => {
            const item = document.createElement('div');
            item.className = 'dvnt-thaydoinen__background-item dvnt-thaydoinen__background-item--color';
            item.style.background = color;
            item.dataset.background = color;
            item.dataset.backgroundType = 'color'; // FIX: Add type identifier
            item.title = `M√†u ${color}`;
            
            // FIX: Don't add individual event listeners here - use delegation
            grid.appendChild(item);
        });
        
        console.log('Created', colors.length, 'color backgrounds'); // Debug log
    }

    createLandscapeBackgrounds(grid) {
        const landscapes = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
            'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)'
        ];

        landscapes.forEach((gradient, index) => {
            const item = document.createElement('div');
            item.className = 'dvnt-thaydoinen__background-item dvnt-thaydoinen__background-item--landscape';
            item.style.background = gradient;
            item.dataset.background = gradient;
            item.dataset.backgroundType = 'gradient'; // FIX: Add type identifier
            item.title = `Phong c·∫£nh ${index + 1}`;
            grid.appendChild(item);
        });
        
        console.log('Created', landscapes.length, 'landscape backgrounds'); // Debug log
    }

    createPatternBackgrounds(grid) {
        const patterns = [
            'repeating-linear-gradient(45deg, #f0f0f0, #f0f0f0 10px, #e0e0e0 10px, #e0e0e0 20px)',
            'repeating-linear-gradient(90deg, #fff, #fff 10px, #f0f0f0 10px, #f0f0f0 20px)',
            'radial-gradient(circle at 20px 20px, #f0f0f0 2px, transparent 2px)',
            'linear-gradient(45deg, #f0f0f0 25%, transparent 25%), linear-gradient(-45deg, #f0f0f0 25%, transparent 25%)',
            'repeating-linear-gradient(0deg, #f0f0f0, #f0f0f0 2px, transparent 2px, transparent 4px)',
            'repeating-linear-gradient(90deg, #f0f0f0, #f0f0f0 2px, transparent 2px, transparent 4px)',
            'radial-gradient(circle at 50% 50%, #f0f0f0 1px, transparent 1px)',
            'conic-gradient(from 0deg, #f0f0f0, #e0e0e0, #f0f0f0)',
            'repeating-conic-gradient(from 0deg, #f0f0f0 0deg 30deg, #e0e0e0 30deg 60deg)',
            'linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%)',
            'radial-gradient(ellipse at center, #f0f0f0 0%, transparent 50%)',
            'repeating-radial-gradient(circle at 50% 50%, #f0f0f0 0px, #f0f0f0 5px, transparent 5px, transparent 10px)'
        ];

        patterns.forEach((pattern, index) => {
            const item = document.createElement('div');
            item.className = 'dvnt-thaydoinen__background-item dvnt-thaydoinen__background-item--pattern';
            item.style.background = pattern;
            item.style.backgroundSize = '20px 20px';
            item.dataset.background = pattern;
            item.dataset.backgroundType = 'pattern'; // FIX: Add type identifier
            item.title = `H·ªça ti·∫øt ${index + 1}`;
            grid.appendChild(item);
        });
        
        console.log('Created', patterns.length, 'pattern backgrounds'); // Debug log
    }

    createUploadBackground(grid) {
        const uploadItem = document.createElement('div');
        uploadItem.className = 'dvnt-thaydoinen__background-item dvnt-thaydoinen__background-item--upload';
        uploadItem.innerHTML = '<span style="font-size: 24px;">üìÅ</span>';
        uploadItem.title = 'T·∫£i l√™n ·∫£nh n·ªÅn t√πy ch·ªânh';
        uploadItem.dataset.backgroundType = 'upload'; // FIX: Add type identifier
        
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.style.display = 'none';
        
        uploadItem.appendChild(input);
        
        // FIX: Use proper event handling for upload
        uploadItem.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent delegation from firing
            input.click();
        });
        
        input.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.selectedBackground = e.target.result;
                    uploadItem.dataset.background = e.target.result;
                    this.renderPreview();
                    this.saveState();
                    this.showNotification('ƒê√£ t·∫£i n·ªÅn t√πy ch·ªânh th√†nh c√¥ng!', 'success');
                };
                reader.readAsDataURL(file);
            }
        });
        
        grid.appendChild(uploadItem);
        console.log('Created upload background option'); // Debug log
    }

    // FIX: Improved background selection handler
    handleBackgroundSelect(event) {
        console.log('Background selected:', event.currentTarget.dataset.background); // Debug log
        
        const items = document.querySelectorAll('.dvnt-thaydoinen__background-item');
        items.forEach(item => item.classList.remove('dvnt-thaydoinen__background-item--active'));
        
        event.currentTarget.classList.add('dvnt-thaydoinen__background-item--active');
        
        // FIX: Get background value properly
        const backgroundValue = event.currentTarget.dataset.background;
        const backgroundType = event.currentTarget.dataset.backgroundType;
        
        if (backgroundValue) {
            this.selectedBackground = backgroundValue;
            console.log('Selected background set to:', this.selectedBackground); // Debug log
            this.renderPreview();
            this.saveState();
            this.showNotification('ƒê√£ ch·ªçn n·ªÅn m·ªõi!', 'success');
        } else {
            console.warn('No background value found for selected item'); // Debug log
        }
    }

    // ==================== CONTROL HANDLING ====================
    handleControlChange(event, index) {
        const value = event.target.value;
        const valueSpan = event.target.parentNode.querySelector('.dvnt-thaydoinen__control-value');
        
        if (valueSpan) {
            switch(index) {
                case 0: // Scale
                    valueSpan.textContent = value + '%';
                    break;
                case 1: // Position X
                    valueSpan.textContent = value + 'px';
                    break;
                case 2: // Position Y
                    valueSpan.textContent = value + 'px';
                    break;
                case 3: // Opacity
                    valueSpan.textContent = value + '%';
                    break;
            }
        }
        
        this.renderPreview();
        this.saveState();
    }

    handleQualityChange(event) {
        this.quality = event.target.value / 100;
        const valueSpan = document.querySelector('.dvnt-thaydoinen__quality-value');
        if (valueSpan) {
            valueSpan.textContent = event.target.value + '%';
        }
        this.updateStatistics();
    }

    resetControls() {
        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        const values = document.querySelectorAll('.dvnt-thaydoinen__control-value');
        
        if (sliders.length >= 4) {
            sliders[0].value = 100; // Scale
            sliders[1].value = 0;   // Position X
            sliders[2].value = 0;   // Position Y
            sliders[3].value = 100; // Opacity
        }
        
        if (values.length >= 4) {
            values[0].textContent = '100%';
            values[1].textContent = '0px';
            values[2].textContent = '0px';
            values[3].textContent = '100%';
        }
        
        this.renderPreview();
        this.saveState();
        this.showNotification('ƒê√£ reset t·∫•t c·∫£ ƒëi·ªÅu khi·ªÉn!', 'info');
    }

    // ==================== NAVIGATION ====================
    previousImage() {
        if (this.selectedFiles.length === 0) return;
        
        this.currentImageIndex = this.currentImageIndex > 0 ? 
            this.currentImageIndex - 1 : 
            this.selectedFiles.length - 1;
        
        this.loadCurrentImage();
        this.showNotification(`·∫¢nh ${this.currentImageIndex + 1}/${this.selectedFiles.length}`, 'info');
    }

    nextImage() {
        if (this.selectedFiles.length === 0) return;
        
        this.currentImageIndex = this.currentImageIndex < this.selectedFiles.length - 1 ? 
            this.currentImageIndex + 1 : 
            0;
        
        this.loadCurrentImage();
        this.showNotification(`·∫¢nh ${this.currentImageIndex + 1}/${this.selectedFiles.length}`, 'info');
    }

    // ==================== RENDERING - FIXED ====================
    renderPreview() {
        if (!this.currentImage || !this.ctx) return;

        const startTime = performance.now();
        
        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        const scale = sliders.length > 0 ? sliders[0].value / 100 : 1;
        const offsetX = sliders.length > 1 ? parseInt(sliders[1].value) : 0;
        const offsetY = sliders.length > 2 ? parseInt(sliders[2].value) : 0;
        const opacity = sliders.length > 3 ? sliders[3].value / 100 : 1;

        // FIX: Clear canvas first
        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
        
        // FIX: Draw background first
        this.drawBackground();

        // FIX: Save context state before applying opacity
        this.ctx.save();
        this.ctx.globalAlpha = opacity;

        const imgWidth = this.currentImage.width * scale;
        const imgHeight = this.currentImage.height * scale;
        const x = (this.canvas.width - imgWidth) / 2 + offsetX;
        const y = (this.canvas.height - imgHeight) / 2 + offsetY;

        this.ctx.drawImage(this.currentImage, x, y, imgWidth, imgHeight);
        
        // FIX: Restore context state
        this.ctx.restore();
        
        this.logProcessingTime('Render preview', startTime);
    }

    // FIX: Completely rewritten drawBackground method
    drawBackground() {
        if (!this.ctx) return;

        console.log('Drawing background:', this.selectedBackground); // Debug log

        // FIX: Default white background
        if (!this.selectedBackground) {
            this.ctx.fillStyle = '#ffffff';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            return;
        }

        // FIX: Handle solid colors
        if (this.selectedBackground.startsWith('#')) {
            this.ctx.fillStyle = this.selectedBackground;
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            console.log('Applied solid color background:', this.selectedBackground); // Debug log
            return;
        }

        // FIX: Handle data URLs (uploaded images)
        if (this.selectedBackground.startsWith('data:')) {
            const img = new Image();
            img.onload = () => {
                this.ctx.drawImage(img, 0, 0, this.canvas.width, this.canvas.height);
                console.log('Applied image background'); // Debug log
                // Re-render the image on top if it exists
                if (this.currentImage) {
                    this.renderImageOnly();
                }
            };
            img.src = this.selectedBackground;
            return;
        }

        // FIX: Handle gradients and patterns
        if (this.selectedBackground.includes('gradient') || this.selectedBackground.includes('repeating')) {
            try {
                // Create a temporary canvas to render CSS gradients/patterns
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width;
                tempCanvas.height = this.canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // For gradients, we need to parse and create manually
                if (this.selectedBackground.includes('linear-gradient')) {
                    this.drawLinearGradient(tempCtx, this.selectedBackground);
                } else if (this.selectedBackground.includes('radial-gradient')) {
                    this.drawRadialGradient(tempCtx, this.selectedBackground);
                } else {
                    // Fallback for complex patterns
                    tempCtx.fillStyle = '#f0f0f0';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                }
                
                // Draw the temp canvas to main canvas
                this.ctx.drawImage(tempCanvas, 0, 0);
                console.log('Applied gradient/pattern background'); // Debug log
                
            } catch (error) {
                console.warn('Error applying gradient background:', error);
                // Fallback to gray
                this.ctx.fillStyle = '#f0f0f0';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            return;
        }

        // FIX: Final fallback
        this.ctx.fillStyle = '#f0f0f0';
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        console.log('Applied fallback background'); // Debug log
    }

    // FIX: Helper method to render only the image (for background callbacks)
    renderImageOnly() {
        if (!this.currentImage || !this.ctx) return;

        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        const scale = sliders.length > 0 ? sliders[0].value / 100 : 1;
        const offsetX = sliders.length > 1 ? parseInt(sliders[1].value) : 0;
        const offsetY = sliders.length > 2 ? parseInt(sliders[2].value) : 0;
        const opacity = sliders.length > 3 ? sliders[3].value / 100 : 1;

        this.ctx.save();
        this.ctx.globalAlpha = opacity;

        const imgWidth = this.currentImage.width * scale;
        const imgHeight = this.currentImage.height * scale;
        const x = (this.canvas.width - imgWidth) / 2 + offsetX;
        const y = (this.canvas.height - imgHeight) / 2 + offsetY;

        this.ctx.drawImage(this.currentImage, x, y, imgWidth, imgHeight);
        this.ctx.restore();
    }

    // FIX: Helper method to draw linear gradients
    drawLinearGradient(ctx, gradientString) {
        try {
            // Parse linear-gradient string
            const match = gradientString.match(/linear-gradient\(([^)]+)\)/);
            if (!match) throw new Error('Invalid gradient format');
            
            const params = match[1].split(',').map(s => s.trim());
            
            // Simple gradient implementation
            const gradient = ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
            
            // Extract colors (simplified)
            const colors = params.filter(p => p.includes('#') || p.includes('rgb'));
            if (colors.length >= 2) {
                gradient.addColorStop(0, colors[0].split(' ')[0]);
                gradient.addColorStop(1, colors[1].split(' ')[0]);
            } else {
                // Fallback colors
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
            }
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
        } catch (error) {
            console.warn('Error parsing linear gradient:', error);
            ctx.fillStyle = '#667eea';
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
    }

    // FIX: Helper method to draw radial gradients
    drawRadialGradient(ctx, gradientString) {
        try {
            const gradient = ctx.createRadialGradient(
                this.canvas.width / 2, this.canvas.height / 2, 0,
                this.canvas.width / 2, this.canvas.height / 2, Math.max(this.canvas.width, this.canvas.height) / 2
            );
            
            gradient.addColorStop(0, '#f0f0f0');
            gradient.addColorStop(1, 'transparent');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
        } catch (error) {
            console.warn('Error creating radial gradient:', error);
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        }
    }

    // ==================== STATISTICS ====================
    updateStatistics() {
        if (!this.selectedFiles.length) return;
        
        const totalImages = this.selectedFiles.length;
        const originalSize = (this.originalTotalSize / 1024 / 1024).toFixed(2);
        
        let estimatedNewSize = this.originalTotalSize;
        switch(this.selectedFormat) {
            case 'jpg':
                estimatedNewSize *= this.quality * 0.7;
                break;
            case 'webp':
                estimatedNewSize *= this.quality * 0.5;
                break;
            case 'png':
                estimatedNewSize *= 0.9;
                break;
            case 'gif':
                estimatedNewSize *= 0.8;
                break;
            case 'bmp':
                estimatedNewSize *= 1.2;
                break;
            case 'tiff':
                estimatedNewSize *= 1.1;
                break;
            default:
                estimatedNewSize *= this.quality;
        }
        
        const newSize = (estimatedNewSize / 1024 / 1024).toFixed(2);
        const savedSize = ((this.originalTotalSize - estimatedNewSize) / 1024 / 1024).toFixed(2);
        const compressionRatio = (((this.originalTotalSize - estimatedNewSize) / this.originalTotalSize) * 100).toFixed(1);
        
        const totalImagesEl = document.getElementById('total-images');
        const originalSizeEl = document.getElementById('original-size');
        const newSizeEl = document.getElementById('new-size');
        const savedSizeEl = document.getElementById('saved-size');
        const compressionRatioEl = document.getElementById('compression-ratio');
        
        if (totalImagesEl) totalImagesEl.textContent = totalImages;
        if (originalSizeEl) originalSizeEl.textContent = originalSize + ' MB';
        if (newSizeEl) newSizeEl.textContent = newSize + ' MB';
        if (savedSizeEl) savedSizeEl.textContent = savedSize + ' MB';
        if (compressionRatioEl) compressionRatioEl.textContent = compressionRatio + '%';
    }

    showStatistics() {
        const statsSection = document.querySelector('.dvnt-thaydoinen__stats-section');
        if (statsSection) {
            statsSection.style.display = 'block';
        }
    }

    displayFileInfo() {
        if (!this.selectedFiles.length) return;
        
        let fileInfoContainer = document.querySelector('.dvnt-thaydoinen__file-info');
        if (!fileInfoContainer) {
            fileInfoContainer = document.createElement('div');
            fileInfoContainer.className = 'dvnt-thaydoinen__file-info';
            
            const uploadSection = document.querySelector('.dvnt-thaydoinen__upload-section');
            if (uploadSection) {
                uploadSection.appendChild(fileInfoContainer);
            }
        }
        
        const fileInfo = this.selectedFiles.map((file, index) => {
            const size = (file.size / 1024 / 1024).toFixed(2);
            const type = file.type || 'Unknown';
            const isActive = index === this.currentImageIndex ? ' <strong>(ƒëang xem)</strong>' : '';
            return `${index + 1}. ${file.name} (${type}, ${size}MB)${isActive}`;
        }).join('<br>');
        
        fileInfoContainer.innerHTML = `
            <strong>üìÅ Files ƒë√£ ch·ªçn (${this.selectedFiles.length}):</strong><br>
            ${fileInfo}
        `;
    }

    // ==================== DOWNLOAD METHODS ====================
    handleFormatChange(event) {
        this.selectedFormat = event.target.value;
        this.updateStatistics();
    }

    downloadImage() {
        if (!this.currentImage || !this.canvas) {
            this.showNotification('Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc!', 'error');
            return;
        }

        const startTime = performance.now();
        const format = this.selectedFormat || 'png';
        const mimeType = this.getMimeType(format);
        
        this.canvas.toBlob((blob) => {
            if (!blob) {
                this.showNotification('L·ªói t·∫°o file ·∫£nh!', 'error');
                return;
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dvnt-image-${this.currentImageIndex + 1}-${Date.now()}.${format}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.logProcessingTime('Download image', startTime);
            this.showNotification('T·∫£i ·∫£nh th√†nh c√¥ng!', 'success');
        }, mimeType, this.quality);
    }

    async downloadAllImages() {
        if (!this.selectedFiles.length) {
            this.showNotification('Kh√¥ng c√≥ ·∫£nh n√†o ƒë·ªÉ t·∫£i!', 'error');
            return;
        }

        if (typeof JSZip === 'undefined') {
            this.showNotification('L·ªói: Th∆∞ vi·ªán JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i!', 'error');
            return;
        }

        const startTime = performance.now();
        const progressContainer = this.createProgressBar();

        try {
            this.showNotification('ƒêang x·ª≠ l√Ω t·∫•t c·∫£ ·∫£nh...', 'info');
            
            const zip = new JSZip();
            const originalIndex = this.currentImageIndex;
            
            for (let i = 0; i < this.selectedFiles.length; i++) {
                this.currentImageIndex = i;
                
                const progress = ((i) / this.selectedFiles.length) * 100;
                this.updateProgressBar(progress, `ƒêang x·ª≠ l√Ω ·∫£nh ${i + 1}/${this.selectedFiles.length}...`);
                
                await this.loadImagePromise(this.selectedFiles[i]);
                const blob = await this.getCanvasBlob();
                
                const fileName = `edited-image-${i + 1}.${this.selectedFormat}`;
                zip.file(fileName, blob);
            }
            
            this.updateProgressBar(100, 'ƒêang t·∫°o file ZIP...');
            
            this.currentImageIndex = originalIndex;
            this.loadCurrentImage();
            
            const zipBlob = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            });
            
            const url = URL.createObjectURL(zipBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `edited-images-${Date.now()}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            this.removeProgressBar();
            this.logProcessingTime('Download all images', startTime);
            this.showNotification('T·∫£i t·∫•t c·∫£ ·∫£nh th√†nh c√¥ng!', 'success');
            
        } catch (error) {
            this.removeProgressBar();
            console.error('Error creating ZIP:', error);
            this.showNotification('L·ªói t·∫°o file ZIP: ' + error.message, 'error');
        }
    }

    loadImagePromise(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    this.currentImage = img;
                    this.renderPreview();
                    resolve();
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    getCanvasBlob() {
        return new Promise((resolve) => {
            const mimeType = this.getMimeType(this.selectedFormat);
            this.canvas.toBlob(resolve, mimeType, this.quality);
        });
    }

    getMimeType(format) {
        const mimeTypes = {
            'png': 'image/png',
            'jpg': 'image/jpeg',
            'jpeg': 'image/jpeg',
            'webp': 'image/webp',
            'gif': 'image/gif',
            'bmp': 'image/bmp',
            'tiff': 'image/tiff'
        };
        return mimeTypes[format] || 'image/png';
    }

    // ==================== PROGRESS BAR ====================
    createProgressBar() {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'dvnt-thaydoinen__progress-container';
        progressContainer.innerHTML = `
            <div class="dvnt-thaydoinen__progress-bar">
                <div class="dvnt-thaydoinen__progress-fill"></div>
            </div>
            <div class="dvnt-thaydoinen__progress-text">ƒêang chu·∫©n b·ªã...</div>
        `;
        
        document.body.appendChild(progressContainer);
        return progressContainer;
    }

    updateProgressBar(progress, text) {
        const progressFill = document.querySelector('.dvnt-thaydoinen__progress-fill');
        const progressText = document.querySelector('.dvnt-thaydoinen__progress-text');
        
        if (progressFill) progressFill.style.width = progress + '%';
        if (progressText) progressText.textContent = text;
    }

    removeProgressBar() {
        const progressContainer = document.querySelector('.dvnt-thaydoinen__progress-container');
        if (progressContainer) {
            progressContainer.remove();
        }
    }

    // ==================== HISTORY SYSTEM ====================
    initializeHistory() {
        this.history = [];
        this.historyIndex = -1;
        this.maxHistorySize = 20;
    }

    saveState() {
        const state = {
            selectedBackground: this.selectedBackground,
            backgroundType: this.backgroundType,
            controls: this.getCurrentControlValues(),
            timestamp: Date.now()
        };

        this.history = this.history.slice(0, this.historyIndex + 1);
        this.history.push(state);
        
        if (this.history.length > this.maxHistorySize) {
            this.history.shift();
        } else {
            this.historyIndex++;
        }

        this.updateUndoRedoButtons();
    }

    undo() {
        if (this.historyIndex > 0) {
            this.historyIndex--;
            this.restoreState(this.history[this.historyIndex]);
            this.updateUndoRedoButtons();
            this.showNotification('ƒê√£ ho√†n t√°c', 'info');
        }
    }

    redo() {
        if (this.historyIndex < this.history.length - 1) {
            this.historyIndex++;
            this.restoreState(this.history[this.historyIndex]);
            this.updateUndoRedoButtons();
            this.showNotification('ƒê√£ l√†m l·∫°i', 'info');
        }
    }

    getCurrentControlValues() {
        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        return {
            scale: sliders[0]?.value || 100,
            offsetX: sliders[1]?.value || 0,
            offsetY: sliders[2]?.value || 0,
            opacity: sliders[3]?.value || 100
        };
    }

    restoreState(state) {
        this.selectedBackground = state.selectedBackground;
        this.backgroundType = state.backgroundType;
        
        const sliders = document.querySelectorAll('.dvnt-thaydoinen__control-slider');
        const values = document.querySelectorAll('.dvnt-thaydoinen__control-value');
        
        if (sliders[0]) sliders[0].value = state.controls.scale;
        if (sliders[1]) sliders[1].value = state.controls.offsetX;
        if (sliders[2]) sliders[2].value = state.controls.offsetY;
        if (sliders[3]) sliders[3].value = state.controls.opacity;
        
        if (values[0]) values[0].textContent = state.controls.scale + '%';
        if (values[1]) values[1].textContent = state.controls.offsetX + 'px';
        if (values[2]) values[2].textContent = state.controls.offsetY + 'px';
        if (values[3]) values[3].textContent = state.controls.opacity + '%';
        
        const tabs = document.querySelectorAll('.dvnt-thaydoinen__tab');
        tabs.forEach(tab => {
            tab.classList.remove('dvnt-thaydoinen__tab--active');
            const tabText = tab.textContent.trim().toLowerCase();
            if ((this.backgroundType === 'color' && tabText === 'm√†u s·∫Øc') ||
                (this.backgroundType === 'landscape' && tabText === 'phong c·∫£nh') ||
                (this.backgroundType === 'pattern' && tabText === 'h·ªça ti·∫øt') ||
                (this.backgroundType === 'upload' && tabText === 't·∫£i l√™n')) {
                tab.classList.add('dvnt-thaydoinen__tab--active');
            }
        });
        
        this.updateBackgroundGrid();
        this.renderPreview();
    }

    updateUndoRedoButtons() {
        const undoBtn = document.querySelector('.dvnt-thaydoinen__undo-btn');
        const redoBtn = document.querySelector('.dvnt-thaydoinen__redo-btn');
        
        if (undoBtn) {
            undoBtn.disabled = this.historyIndex <= 0;
            undoBtn.classList.toggle('dvnt-thaydoinen__btn--disabled', this.historyIndex <= 0);
        }
        
        if (redoBtn) {
            redoBtn.disabled = this.historyIndex >= this.history.length - 1;
            redoBtn.classList.toggle('dvnt-thaydoinen__btn--disabled', this.historyIndex >= this.history.length - 1);
        }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    setupKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.target.matches('input, textarea, select')) return;
            
            if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                this.undo();
            }
            
            if ((e.ctrlKey && e.shiftKey && e.key === 'Z') || (e.ctrlKey && e.key === 'y')) {
                e.preventDefault();
                this.redo();
            }
            
            if (e.code === 'Space') {
                e.preventDefault();
                this.nextImage();
            }
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                this.previousImage();
            }
            
            if (e.key === 'ArrowRight') {
                e.preventDefault();
                this.nextImage();
            }
            
            if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                this.resetControls();
            }
            
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                this.downloadImage();
            }
            
            if (e.key === 'c' || e.key === 'C') {
                e.preventDefault();
                this.createComparisonView();
            }
        });
    }

    // ==================== COMPARISON VIEW ====================
    createComparisonView() {
        if (!this.currentImage) {
            this.showNotification('Vui l√≤ng ch·ªçn ·∫£nh tr∆∞·ªõc!', 'error');
            return;
        }
        
        const comparisonContainer = document.createElement('div');
        comparisonContainer.className = 'dvnt-thaydoinen__comparison-container';
        comparisonContainer.innerHTML = `
            <div class="dvnt-thaydoinen__comparison-content">
                <div class="dvnt-thaydoinen__comparison-header">
                    <h3>üîç So s√°nh Before/After</h3>
                    <button class="dvnt-thaydoinen__comparison-close">‚úï</button>
                </div>
                <div class="dvnt-thaydoinen__comparison-grid">
                    <div class="dvnt-thaydoinen__comparison-item">
                        <h4>·∫¢nh g·ªëc</h4>
                        <canvas class="dvnt-thaydoinen__comparison-canvas" id="original-canvas"></canvas>
                    </div>
                    <div class="dvnt-thaydoinen__comparison-item">
                        <h4>·∫¢nh ƒë√£ ch·ªânh s·ª≠a</h4>
                        <canvas class="dvnt-thaydoinen__comparison-canvas" id="edited-canvas"></canvas>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(comparisonContainer);
        
        const closeBtn = comparisonContainer.querySelector('.dvnt-thaydoinen__comparison-close');
        closeBtn.addEventListener('click', () => {
            comparisonContainer.remove();
        });
        
        comparisonContainer.addEventListener('click', (e) => {
            if (e.target === comparisonContainer) {
                comparisonContainer.remove();
            }
        });
        
        this.drawComparisonImages();
    }

    drawComparisonImages() {
        const originalCanvas = document.getElementById('original-canvas');
        const editedCanvas = document.getElementById('edited-canvas');
        
        if (!originalCanvas || !editedCanvas || !this.currentImage) return;
        
        originalCanvas.width = editedCanvas.width = 400;
        originalCanvas.height = editedCanvas.height = 300;
        
        const originalCtx = originalCanvas.getContext('2d');
        const editedCtx = editedCanvas.getContext('2d');
        
        originalCtx.fillStyle = '#ffffff';
        originalCtx.fillRect(0, 0, 400, 300);
        
        const scale = Math.min(400 / this.currentImage.width, 300 / this.currentImage.height);
        const width = this.currentImage.width * scale;
        const height = this.currentImage.height * scale;
        const x = (400 - width) / 2;
        const y = (300 - height) / 2;
        
        originalCtx.drawImage(this.currentImage, x, y, width, height);
        editedCtx.drawImage(this.canvas, 0, 0, this.canvas.width, this.canvas.height, 0, 0, 400, 300);
    }

    // ==================== AUTO-SAVE & RECOVERY ====================
    enableAutoSave() {
        this.autoSaveInterval = setInterval(() => {
            if (this.selectedFiles.length > 0) {
                this.saveToLocalStorage();
            }
        }, 30000);
    }

    saveToLocalStorage() {
        const saveData = {
            filesInfo: this.selectedFiles.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type
            })),
            currentIndex: this.currentImageIndex,
            selectedBackground: this.selectedBackground,
            backgroundType: this.backgroundType,
            controls: this.getCurrentControlValues(),
            format: this.selectedFormat,
            quality: this.quality,
            timestamp: Date.now()
        };
        
        try {
            localStorage.setItem('dvnt-background-changer-autosave', JSON.stringify(saveData));
            console.log('Auto-saved successfully');
        } catch (error) {
            console.warn('Auto-save failed:', error);
        }
    }

    loadFromLocalStorage() {
        try {
            const saveData = localStorage.getItem('dvnt-background-changer-autosave');
            if (saveData) {
                const data = JSON.parse(saveData);
                
                const hoursSinceLastSave = (Date.now() - data.timestamp) / (1000 * 60 * 60);
                if (hoursSinceLastSave < 24) {
                    this.showRestoreDialog(data);
                }
            }
        } catch (error) {
            console.warn('Failed to load auto-save:', error);
        }
    }

    showRestoreDialog(saveData) {
        const dialog = document.createElement('div');
        dialog.className = 'dvnt-thaydoinen__restore-dialog';
        dialog.innerHTML = `
            <div class="dvnt-thaydoinen__restore-content">
                <h3>üíæ Kh√¥i ph·ª•c phi√™n l√†m vi·ªác</h3>
                <p>T√¨m th·∫•y phi√™n l√†m vi·ªác ƒë√£ l∆∞u t·ª´ <strong>${new Date(saveData.timestamp).toLocaleString('vi-VN')}</strong>.</p>
                <p>C√≥ <strong>${saveData.filesInfo.length}</strong> ·∫£nh ƒë√£ ƒë∆∞·ª£c t·∫£i.</p>
                <div class="dvnt-thaydoinen__restore-actions">
                    <button class="dvnt-thaydoinen__restore-btn" data-action="restore">Kh√¥i ph·ª•c</button>
                    <button class="dvnt-thaydoinen__restore-btn" data-action="dismiss">B·ªè qua</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
        
        dialog.addEventListener('click', (e) => {
            if (e.target.dataset.action === 'restore') {
                this.restoreFromSaveData(saveData);
                this.showNotification('ƒê√£ kh√¥i ph·ª•c phi√™n l√†m vi·ªác!', 'success');
            }
            dialog.remove();
        });
    }

    restoreFromSaveData(saveData) {
        this.currentImageIndex = saveData.currentIndex;
        this.selectedBackground = saveData.selectedBackground;
        this.backgroundType = saveData.backgroundType;
        this.selectedFormat = saveData.format;
        this.quality = saveData.quality;
        
        this.restoreState({ 
            selectedBackground: saveData.selectedBackground,
            backgroundType: saveData.backgroundType,
            controls: saveData.controls 
        });
    }

    // ==================== PERFORMANCE MONITORING ====================
    startPerformanceMonitoring() {
        this.performanceMetrics = {
            processingTimes: [],
            memoryUsage: [],
            startTime: performance.now()
        };
        
        if ('memory' in performance) {
            setInterval(() => {
                this.performanceMetrics.memoryUsage.push({
                    used: performance.memory.usedJSHeapSize,
                    total: performance.memory.totalJSHeapSize,
                    timestamp: performance.now()
                });
                
                if (this.performanceMetrics.memoryUsage.length > 100) {
                    this.performanceMetrics.memoryUsage.shift();
                }
            }, 5000);
        }
    }

    logProcessingTime(operation, startTime) {
        const duration = performance.now() - startTime;
        this.performanceMetrics.processingTimes.push({
            operation,
            duration,
            timestamp: performance.now()
        });
        
        console.log(`${operation} took ${duration.toFixed(2)}ms`);
        
        if (this.performanceMetrics.processingTimes.length > 50) {
            this.performanceMetrics.processingTimes.shift();
        }
    }

    // ==================== ERROR RECOVERY ====================
    setupErrorRecovery() {
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            this.showNotification('ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën. ƒêang c·ªë g·∫Øng kh√¥i ph·ª•c...', 'error');
            
            setTimeout(() => {
                this.recoverFromError();
            }, 1000);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            this.showNotification('L·ªói x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô. ƒêang kh√¥i ph·ª•c...', 'error');
            e.preventDefault();
        });
    }

    recoverFromError() {
        try {
            if (!this.ctx || !this.canvas) {
                this.initializeCanvas();
            }
            
            if (this.currentImage) {
                this.renderPreview();
            }
            
            this.enableDownloadButtons();
            this.showNotification('ƒê√£ kh√¥i ph·ª•c th√†nh c√¥ng!', 'success');
        } catch (error) {
            console.error('Recovery failed:', error);
            this.showNotification('Kh√¥ng th·ªÉ kh√¥i ph·ª•c. Vui l√≤ng t·∫£i l·∫°i trang.', 'error');
        }
    }

    // ==================== CLEANUP ====================
    setupCleanup() {
        window.addEventListener('beforeunload', () => {
            if (this.autoSaveInterval) {
                clearInterval(this.autoSaveInterval);
            }
            
            if (this.selectedFiles.length > 0) {
                this.saveToLocalStorage();
            }
        });
    }

    // ==================== UTILITY METHODS ====================
        enableDownloadButtons() {
        const downloadBtn = document.querySelector('.dvnt-thaydoinen__download-btn');
        const downloadAllBtn = document.querySelector('.dvnt-thaydoinen__download-all-btn');
        
        if (downloadBtn) {
            downloadBtn.disabled = false;
            downloadBtn.classList.remove('dvnt-thaydoinen__download-btn--disabled');
        }
        
        if (downloadAllBtn) {
            downloadAllBtn.disabled = false;
            downloadAllBtn.classList.remove('dvnt-thaydoinen__download-btn--disabled');
        }
    }

    showNotification(message, type = 'info') {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.dvnt-thaydoinen__notification');
        existingNotifications.forEach(notification => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
        
        const notification = document.createElement('div');
        notification.className = `dvnt-thaydoinen__notification dvnt-thaydoinen__notification--${type}`;
        notification.textContent = message;

        if (type === 'warning') {
            notification.style.color = '#212529';
        }

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto remove after 3 seconds
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // ==================== INITIALIZATION ====================
    initializeAdvancedFeatures() {
        this.initializeHistory();
        this.setupKeyboardShortcuts();
        this.enableAutoSave();
        this.loadFromLocalStorage();
        this.startPerformanceMonitoring();
        this.setupErrorRecovery();
        this.setupCleanup();
        
        // Save initial state
        this.saveState();
        
        console.log('üöÄ DVNT Background Changer initialized successfully!');
        console.log('üìã Keyboard shortcuts:');
        console.log('  Ctrl+Z: Undo');
        console.log('  Ctrl+Y: Redo');
        console.log('  Space: Next image');
        console.log('  ‚Üê/‚Üí: Navigate images');
        console.log('  R: Reset controls');
        console.log('  C: Compare before/after');
        console.log('  Ctrl+Enter: Download current image');
    }
}

// ==================== INITIALIZATION ====================
document.addEventListener('DOMContentLoaded', () => {
    // Initialize the application
    window.dvntApp = new DVNTBackgroundChanger();
    
    // Add global error handler for debugging
    window.addEventListener('error', (e) => {
        console.error('Application error:', e.error);
    });
    
    console.log('‚úÖ DVNT Background Changer loaded successfully!');
});

// Export for potential module usage
if (typeof module !== 'undefined' && module.exports) {
    module.exports = DVNTBackgroundChanger;
}


    </script>
</body>
</html>
